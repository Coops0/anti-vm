use windows::Devices::Usb::UsbDeviceDescriptor;
use windows::Win32::Devices::DeviceAndDriverInstallation;
use windows::{
    Devices::{
        Enumeration::{DeviceInformation, DeviceInformationKind},
        Usb::{self, UsbDevice, UsbDeviceClass},
    },
    Win32::Devices::DeviceAndDriverInstallation::*,
};
use windows_core::{GUID, HSTRING, Interface, h, w};

use crate::util::get_devices_iter;

pub fn get_usb_devices() -> anyhow::Result<usize> {
    let mut devices = GUIDS
        .iter()
        .filter_map(|guid| UsbDevice::GetDeviceSelectorGuidOnly(*guid).ok())
        .filter_map(|selector| get_devices_iter(&selector).ok())
        .flatten()
        .collect::<Vec<_>>();

    devices.dedup_by(|a, b| a.Id() == b.Id());

    for device in devices {
        println!("Device: {:?}", device);
    }

    Ok(0)
}

const GUIDS: &[GUID] = &[
    GUID_BUS_RESOURCE_UPDATE_INTERFACE,
    GUID_BUS_TYPE_1394,
    GUID_BUS_TYPE_ACPI,
    GUID_BUS_TYPE_AVC,
    GUID_BUS_TYPE_DOT4PRT,
    GUID_BUS_TYPE_EISA,
    GUID_BUS_TYPE_HID,
    GUID_BUS_TYPE_INTERNAL,
    GUID_BUS_TYPE_IRDA,
    GUID_BUS_TYPE_ISAPNP,
    GUID_BUS_TYPE_LPTENUM,
    GUID_BUS_TYPE_MCA,
    GUID_BUS_TYPE_PCI,
    GUID_BUS_TYPE_PCMCIA,
    GUID_BUS_TYPE_SCM,
    GUID_BUS_TYPE_SD,
    GUID_BUS_TYPE_SERENUM,
    GUID_BUS_TYPE_SW_DEVICE,
    GUID_BUS_TYPE_USB,
    GUID_BUS_TYPE_USBPRINT,
    GUID_D3COLD_AUX_POWER_AND_TIMING_INTERFACE,
    GUID_D3COLD_SUPPORT_INTERFACE,
    GUID_DEVCLASS_1394,
    GUID_DEVCLASS_1394DEBUG,
    GUID_DEVCLASS_61883,
    GUID_DEVCLASS_ADAPTER,
    GUID_DEVCLASS_APMSUPPORT,
    GUID_DEVCLASS_AVC,
    GUID_DEVCLASS_BATTERY,
    GUID_DEVCLASS_BIOMETRIC,
    GUID_DEVCLASS_BLUETOOTH,
    GUID_DEVCLASS_CAMERA,
    GUID_DEVCLASS_CDROM,
    GUID_DEVCLASS_COMPUTEACCELERATOR,
    GUID_DEVCLASS_COMPUTER,
    GUID_DEVCLASS_DECODER,
    GUID_DEVCLASS_DISKDRIVE,
    GUID_DEVCLASS_DISPLAY,
    GUID_DEVCLASS_DOT4,
    GUID_DEVCLASS_DOT4PRINT,
    GUID_DEVCLASS_EHSTORAGESILO,
    GUID_DEVCLASS_ENUM1394,
    GUID_DEVCLASS_EXTENSION,
    GUID_DEVCLASS_FDC,
    GUID_DEVCLASS_FIRMWARE,
    GUID_DEVCLASS_FLOPPYDISK,
    GUID_DEVCLASS_FSFILTER_ACTIVITYMONITOR,
    GUID_DEVCLASS_FSFILTER_ANTIVIRUS,
    GUID_DEVCLASS_FSFILTER_BOTTOM,
    GUID_DEVCLASS_FSFILTER_CFSMETADATASERVER,
    GUID_DEVCLASS_FSFILTER_COMPRESSION,
    GUID_DEVCLASS_FSFILTER_CONTENTSCREENER,
    GUID_DEVCLASS_FSFILTER_CONTINUOUSBACKUP,
    GUID_DEVCLASS_FSFILTER_COPYPROTECTION,
    GUID_DEVCLASS_FSFILTER_ENCRYPTION,
    GUID_DEVCLASS_FSFILTER_HSM,
    GUID_DEVCLASS_FSFILTER_INFRASTRUCTURE,
    GUID_DEVCLASS_FSFILTER_OPENFILEBACKUP,
    GUID_DEVCLASS_FSFILTER_PHYSICALQUOTAMANAGEMENT,
    GUID_DEVCLASS_FSFILTER_QUOTAMANAGEMENT,
    GUID_DEVCLASS_FSFILTER_REPLICATION,
    GUID_DEVCLASS_FSFILTER_SECURITYENHANCER,
    GUID_DEVCLASS_FSFILTER_SYSTEM,
    GUID_DEVCLASS_FSFILTER_SYSTEMRECOVERY,
    GUID_DEVCLASS_FSFILTER_TOP,
    GUID_DEVCLASS_FSFILTER_UNDELETE,
    GUID_DEVCLASS_FSFILTER_VIRTUALIZATION,
    GUID_DEVCLASS_GENERIC,
    GUID_DEVCLASS_GPS,
    GUID_DEVCLASS_HDC,
    GUID_DEVCLASS_HIDCLASS,
    GUID_DEVCLASS_HOLOGRAPHIC,
    GUID_DEVCLASS_IMAGE,
    GUID_DEVCLASS_INFINIBAND,
    GUID_DEVCLASS_INFRARED,
    GUID_DEVCLASS_KEYBOARD,
    GUID_DEVCLASS_LEGACYDRIVER,
    GUID_DEVCLASS_MEDIA,
    GUID_DEVCLASS_MEDIUM_CHANGER,
    GUID_DEVCLASS_MEMORY,
    GUID_DEVCLASS_MODEM,
    GUID_DEVCLASS_MONITOR,
    GUID_DEVCLASS_MOUSE,
    GUID_DEVCLASS_MTD,
    GUID_DEVCLASS_MULTIFUNCTION,
    GUID_DEVCLASS_MULTIPORTSERIAL,
    GUID_DEVCLASS_NET,
    GUID_DEVCLASS_NETCLIENT,
    GUID_DEVCLASS_NETDRIVER,
    GUID_DEVCLASS_NETSERVICE,
    GUID_DEVCLASS_NETTRANS,
    GUID_DEVCLASS_NETUIO,
    GUID_DEVCLASS_NODRIVER,
    GUID_DEVCLASS_PCMCIA,
    GUID_DEVCLASS_PNPPRINTERS,
    GUID_DEVCLASS_PORTS,
    GUID_DEVCLASS_PRIMITIVE,
    GUID_DEVCLASS_PRINTER,
    GUID_DEVCLASS_PRINTERUPGRADE,
    GUID_DEVCLASS_PRINTQUEUE,
    GUID_DEVCLASS_PROCESSOR,
    GUID_DEVCLASS_SBP2,
    GUID_DEVCLASS_SCMDISK,
    GUID_DEVCLASS_SCMVOLUME,
    GUID_DEVCLASS_SCSIADAPTER,
    GUID_DEVCLASS_SECURITYACCELERATOR,
    GUID_DEVCLASS_SENSOR,
    GUID_DEVCLASS_SIDESHOW,
    GUID_DEVCLASS_SMARTCARDREADER,
    GUID_DEVCLASS_SMRDISK,
    GUID_DEVCLASS_SMRVOLUME,
    GUID_DEVCLASS_SOFTWARECOMPONENT,
    GUID_DEVCLASS_SOUND,
    GUID_DEVCLASS_SYSTEM,
    GUID_DEVCLASS_TAPEDRIVE,
    GUID_DEVCLASS_UCM,
    GUID_DEVCLASS_UNKNOWN,
    GUID_DEVCLASS_USB,
    GUID_DEVCLASS_VOLUME,
    GUID_DEVCLASS_VOLUMESNAPSHOT,
    GUID_DEVCLASS_WCEUSBS,
    GUID_DEVCLASS_WPD,
];

const REQUESTED_PROPERTIES: &[&str] = &[
    "System.Devices.GlyphIcon",
    "System.Devices.Aep.AepId",
    "System.Devices.Aep.CanPair",
    "System.Devices.Aep.Category",
    "System.Devices.Aep.ContainerId",
    "System.Devices.Aep.DeviceAddress",
    "System.Devices.Aep.IsConnected",
    "System.Devices.Aep.IsPaired",
    "System.Devices.Aep.IsPresent",
    "System.Devices.Aep.Manufacturer",
    "System.Devices.Aep.ModelId",
    "System.Devices.Aep.ModelName",
    "System.Devices.Aep.ProtocolId",
    "System.Devices.Aep.SignalStrength",
    // these are specific to bluetooth
    "System.Devices.Aep.Bluetooth.LastSeenTime",
    "System.Devices.Aep.Bluetooth.IssueInquiry",
    "System.Devices.Aep.Bluetooth.Le.ActiveScanning",
    "System.Devices.Aep.Bluetooth.Le.AddressType",
    "System.Devices.Aep.Bluetooth.Le.Appearance",
    "System.Devices.Aep.Bluetooth.Le.Appearance.Category",
    "System.Devices.Aep.Bluetooth.Le.Appearance.Subcategory",
    "System.Devices.Aep.Bluetooth.Le.IsConnectable",
    "System.Devices.Aep.Bluetooth.Le.ScanInterval",
    "System.Devices.Aep.Bluetooth.Le.ScanResponse",
    "System.Devices.Aep.Bluetooth.Le.ScanWindow",
];
