use nusb::{DeviceInfo, InterfaceInfo};

use crate::flags::Flags;

pub fn score_usb_devices(flags: &mut Flags) -> anyhow::Result<()> {
    let mut valid_devices = 0u32;
    for dev in nusb::list_devices()? {
        let score_before = flags.score();
        score_device(&dev, flags);

        // if score was not decreased by at least 5, treat it as real
        if flags.score() >= (score_before - 5) {
            valid_devices += 1;
        }
    }

    println!("valid devices: {valid_devices}");
    match valid_devices {
        0 => flags.large_penalty(),
        1..=5 => {}
        _ => flags.large_bonus(),
    }

    Ok(())
}

fn score_device(dev: &DeviceInfo, flags: &mut Flags) {
    // https://the-sz.com/products/usbid/index.php
    if 
    // Vmware
    dev.vendor_id() == 0x0E0F || dev.vendor_id() == 0x15AD || 
    // VirtualBox
    dev.vendor_id() == 0x80EE ||
    // Parallels
    dev.vendor_id() == 0x203A ||
    // QEMU
    dev.vendor_id() == 0x46F4
    {
        flags.end_all_penalty();
    }

    // Intel bluetooth
    if dev.vendor_id() == 0x8087
        && ( 
        dev.product_id() == 0x0025 || 
        dev.product_id() == 0x0026 ||
        dev.product_id() == 0x0029 ||
        dev.product_id() == 0x0032 ||
        dev.product_id() == 0x0033 ||
        dev.product_id() == 0x0036 ||
        // These are bluetooth wireless interfaces
        dev.product_id() == 0x07DC ||
        dev.product_id() == 0x0A2A ||
        dev.product_id() == 0x0A2B ||
        // Wireless-AC 3168 Bluetooth
        dev.product_id() == 0x0AA7 ||
        dev.product_id() == 0x0AAA
    )
    {
        flags.large_bonus();
    }

    if REAL_VENDORS.iter().any(|v| *v == dev.vendor_id()) {
        flags.medium_bonus();
    }

    if let Some(product) = dev.product_string() {
        if product.contains("VMware") || product.contains("VirtualBox") {
            flags.end_all_penalty();
        }
    }

    // VMware
    if dev
        .instance_id()
        .eq_ignore_ascii_case("USB\\VID_0E0F&PID_0003\\6&39D724FE")
    {
        flags.end_all_penalty();
    }

    if let Some(driver) = dev.driver() {
        if driver == "FocusriteUsb" {
            flags.large_bonus();
        }
    }

    for interface in dev.interfaces() {
        score_interface(interface, flags);
    }
}

fn score_interface(int: &InterfaceInfo, flags: &mut Flags) {
    if let Some(str) = int.interface_string() {
        if str.contains("VMware") || str.contains("VirtualBox") {
            flags.end_all_penalty();
        }

        if str == "Keychron Link" {
            flags.large_bonus();
        }

        if str.contains("NuPhy") {
            flags.large_bonus();
        }
    }
}

const REAL_VENDORS: &[u16] = &[
    0x1235, 0x19F5, 0x0502, 0x1668, 0x125F, 0x0459, 0x30A5, 0x08CA, 0x187C, 0x044E, 0x2DE6, 0x051D, 0x291A, 0x1005, 0x05AC, 0x0E79, 0x0840, 0x26CE, 0x9886, 0x0486, 0x0557, 0x0909, 0x057C, 0x290B, 0x050D, 0x04A5, 0x2E50, 0x30B1, 0x1EDB, 0x05A7, 0x04F9, 0x0411, 0x04A9, 0x046A, 0x05A6, 0x2D1C, 0x2516, 0x1B1C, 0x041E, 0x05DE, 0x0764, 0x07D1, 0x413C, 0x05DD, 0x2CA3, 0x3233, 0x0922, 0x2D99, 0x056D, 0x0CF2, 0x03F8, 0x2972, 0x2687, 0x37C1, 0x0E67, 0x0489, 0x36BC, 0x0406, 0x091E, 0x0414, 0x3794, 0x4255, 0x077D, 0x06F8, 0x147F, 0x05FC, 0x09C3, 0x04A4, 0x339B, 0x03F0, 0x0BB4, 0x12D1, 0x04B3, 0x4101, 0x4102, 0x0DA7, 0x059B, 0x2DE5, 0x047D, 0x3434, 0x0951, 0x30DE, 0x18B5, 0x2237, 0x040A, 0x0944, 0x253D, 0x0482, 0x059F, 0x1949, 0x0672, 0x17EF, 0x05DC, 0x043D, 0x1004, 0x13B1, 0x046D, 0x0763, 0x08AE, 0x0738, 0x359B, 0x18EA, 0x0D49, 0x2A45, 0x12F7, 0x045E, 0x0DB0, 0x2E26, 0x0534, 0x4D46, 0x055F, 0x11C9, 0x17CC, 0x0409, 0x2467, 0x0846, 0x2C3F, 0x04B0, 0x057E, 0x0421, 0x1410, 0x1E71, 0x2833, 0x06BC, 0x07B4, 0x2A70, 0x0101, 0x22D9, 0x055E, 0x7825, 0x2836, 0x2E43, 0x2D14, 0x0830, 0x04DA, 0x19CF, 0x1502, 0x2A7F, 0x0471, 0x34A4, 0x2304, 0x08E4, 0x093A, 0x047F, 0x093B, 0x0B30, 0x20D6, 0x194F, 0x0461, 0x2C99, 0x1C04, 0x1689, 0x0B03, 0x045B, 0x05CA, 0x0F2F, 0x1E7D, 0x382B, 0x0582, 0x2D9F, 0x06A3, 0x0419, 0x0781, 0x0474, 0x2E82, 0x1204, 0x0477, 0x2886, 0x0CA3, 0x04B8, 0x1377, 0x1EA7, 0x04DD, 0x14ED, 0x4971, 0x34F0, 0x0B8C, 0x2A8C, 0x054C, 0x1038, 0x1BCF, 0x06CB, 0xF400, 0x4168, 0x1604, 0x0644, 0x2604, 0x264A, 0x27B8, 0x044F, 0x1390, 0x0853, 0x06D5, 0x2357, 0x8564, 0x20F4, 0x09AE, 0x10F5, 0x04C1, 0x2B89, 0x28C7, 0x2B5A, 0x2A7E, 0x28DE, 0x18A5, 0x0543, 0x135A, 0x2AE2, 0x1058, 0x31E3, 0x2717, 0x0B4B, 0x0499, 0x1050, 0x1C57, 0x05E0, 0x1EE9, 0x2345, 0x19D2, 0x0586
];
